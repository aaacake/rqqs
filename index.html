<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业网站管理系统 - Parse 版本</title>
    <!-- 添加 Parse SDK -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        /* 保持原有的所有样式不变 */
        /* ... 原有样式代码 ... */
    </style>
</head>
<body>
    <!-- 保持原有的HTML结构不变 -->
    <!-- ... 原有HTML代码 ... -->

    <script>
        // ========== Parse 初始化 ==========
        Parse.initialize(
            "YOUR_APPLICATION_ID",   // 替换为你的 Application ID
            "YOUR_JAVASCRIPT_KEY"    // 替换为你的 JavaScript Key
        );
        Parse.serverURL = "YOUR_SERVER_URL";  // 替换为你的服务器 URL
        
        // 创建 WebsiteContent 类（如果不存在）
        const WebsiteContent = Parse.Object.extend("WebsiteContent");
        
        // ========== 页面加载后执行 ==========
        document.addEventListener('DOMContentLoaded', function() {
            // 保持原有的主题切换、菜单功能等代码不变
            // ... 原有代码 ...
            
            // ========== 修改后的管理员登录功能 ==========
            const adminLoginBtn = document.getElementById('adminLogin');
            const adminPanel = document.getElementById('adminPanel');
            
            // 处理管理员登录
            function handleAdminLogin() {
                const password = prompt("请输入管理员密码:");
                if (password === "admin123") {
                    adminPanel.style.display = "block";
                    adminLoginBtn.style.display = "none";
                    updateStatus("管理员已登录");
                    
                    // 加载内容
                    loadInitialContent();
                } else {
                    alert("密码错误!");
                }
            }
            
            adminLoginBtn.addEventListener('click', handleAdminLogin);
            
            // ========== 修改后的保存编辑内容 ==========
            async function saveContent() {
                document.querySelectorAll(".editable").forEach(element => {
                    element.contentEditable = false;
                    element.classList.remove('editing');
                });
                saveBtn.style.display = "none";
                cancelBtn.style.display = "none";
                editBtn.style.display = "inline-block";
                
                // 获取当前页面状态
                const isHomePage = homeContentDiv.style.display !== 'none';
                
                try {
                    if (isHomePage) {
                        // 保存首页内容
                        const homeContent = document.getElementById('homeContent').innerHTML;
                        await saveToParse("home", { content: homeContent });
                        updateStatus("首页内容已保存到数据库");
                    } else {
                        // 保存子页面内容
                        const currentSubTitle = subTitle.textContent;
                        const currentContent = subDetails.innerHTML;
                        
                        await saveToParse("subPage", { 
                            pageName: currentSubTitle,
                            content: currentContent 
                        });
                        updateStatus(`"${currentSubTitle}"内容已保存到数据库`);
                    }
                    updateLastSavedTime();
                } catch (error) {
                    console.error("保存失败:", error);
                    updateStatus("保存失败: " + error.message);
                }
            }
            
            // ========== 保存数据到 Parse ==========
            async function saveToParse(type, data) {
                const query = new Parse.Query(WebsiteContent);
                
                if (type === "home") {
                    query.equalTo("type", "home");
                    const results = await query.first();
                    
                    if (results) {
                        results.set("content", data.content);
                        return results.save();
                    } else {
                        const content = new WebsiteContent();
                        content.set("type", "home");
                        content.set("content", data.content);
                        return content.save();
                    }
                } else if (type === "subPage") {
                    query.equalTo("type", "subPage");
                    query.equalTo("pageName", data.pageName);
                    const results = await query.first();
                    
                    if (results) {
                        results.set("content", data.content);
                        return results.save();
                    } else {
                        const content = new WebsiteContent();
                        content.set("type", "subPage");
                        content.set("pageName", data.pageName);
                        content.set("content", data.content);
                        return content.save();
                    }
                }
            }
            
            // ========== 从 Parse 加载内容 ==========
            async function loadInitialContent() {
                try {
                    // 加载首页内容
                    const homeQuery = new Parse.Query(WebsiteContent);
                    homeQuery.equalTo("type", "home");
                    const homeResult = await homeQuery.first();
                    
                    if (homeResult) {
                        document.getElementById('homeContent').innerHTML = homeResult.get("content");
                    }
                    
                    // 加载所有子页面内容
                    const subPagesQuery = new Parse.Query(WebsiteContent);
                    subPagesQuery.equalTo("type", "subPage");
                    const subPagesResults = await subPagesQuery.find();
                    
                    subPagesResults.forEach(result => {
                        const pageName = result.get("pageName");
                        const content = result.get("content");
                        contentMap[pageName] = content;
                    });
                    
                } catch (error) {
                    console.error("加载内容失败:", error);
                }
            }
            
            // ========== 修改后的添加新内容功能 ==========
            async function addNewContent() {
                const newContent = newContentInput.value;
                if (newContent) {
                    try {
                        // 获取当前首页内容
                        const query = new Parse.Query(WebsiteContent);
                        query.equalTo("type", "home");
                        const result = await query.first();
                        
                        let currentContent = "";
                        if (result) {
                            currentContent = result.get("content");
                        }
                        
                        currentContent += `<div class="editable">${newContent}</div>`;
                        
                        // 保存更新后的内容
                        await saveToParse("home", { content: currentContent });
                        
                        newContentInput.value = "";
                        updateStatus("新内容已添加到首页并保存到数据库");
                        updateLastSavedTime();
                    } catch (error) {
                        console.error("添加失败:", error);
                        updateStatus("添加失败: " + error.message);
                    }
                } else {
                    alert("请输入内容后再添加！");
                }
            }
            
            // ========== 修改后的重置内容功能 ==========
            async function resetContent() {
                if (confirm("确定要重置所有编辑内容吗？此操作不可撤销。")) {
                    try {
                        const defaultContent = "欢迎访问我们的企业网站！这里可以展示公司最新动态和重要信息。企业网站管理系统让您轻松管理网站内容，无需技术背景即可完成内容更新与维护。";
                        
                        await saveToParse("home", { content: defaultContent });
                        
                        newContentInput.value = "";
                        updateStatus("内容已重置为默认值并保存到数据库");
                        updateLastSavedTime();
                    } catch (error) {
                        console.error("重置失败:", error);
                        updateStatus("重置失败: " + error.message);
                    }
                }
            }
            
            // ========== 更新最后保存时间 ==========
            function updateLastSavedTime() {
                const now = new Date();
                document.getElementById('lastSaved').textContent = 
                    `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            }
            
            // 页面加载时获取内容
            loadInitialContent();
        });
    </script>
</body>
</html>
